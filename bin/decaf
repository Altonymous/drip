#!/usr/bin/env bash

skip=false

jvm_args=''

for arg in "$@"; do
    if [ -z $main_class ]; then
        if $skip; then
            skip=false
        else
            if [ $arg == "-cp" ] || [ $arg == "-classpath" ]; then
                skip=true        
            elif [[ $arg != -* ]]; then 
                main_class=$arg
                continue
            fi
        fi
        jvm_args="$jvm_args $arg"
    else
        if [ -z $main_args ]; then
            main_args=$arg
        else
            main_args="$main_args\t$arg"
        fi
    fi
done

rm decaf.in decaf.out
mkfifo decaf.in
mkfifo decaf.out

java $jvm_args org.flatland.decaf.Main < decaf.in > decaf.out &

exec 3> decaf.in
exec 4< decaf.out
printf "$main_class\n$main_args\n" >&3

while true; do
    read -t 0.001 line     && echo "$line" >&3
    read -t 0.001 line <&4 && echo "$line"
    if [ $? == 1 ]; then
        exit 0
    fi
done
