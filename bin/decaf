#!/usr/bin/env bash

skip=false

jvm_args=''

for arg in "$@"; do
    if [ -z $main_class ]; then
        if $skip; then
            skip=false
        else
            if [ $arg == "-cp" ] || [ $arg == "-classpath" ]; then
                skip=true
            elif [[ $arg != -* ]]; then
                main_class=$arg
                continue
            fi
        fi
        jvm_args="$jvm_args $arg"
    else
        if [ -z $main_args ]; then
            main_args=$arg
        else
            main_args="$main_args\t$arg"
        fi
    fi
done

rm decaf.in decaf.out decaf.err
mkfifo decaf.in
mkfifo decaf.out
mkfifo decaf.err

java $jvm_args org.flatland.decaf.Main < decaf.in > decaf.out 2> decaf.err &

exec 3> decaf.in
exec 4< decaf.out
exec 5< decaf.err
printf "$main_class\n$main_args\n" >&3

IFS=
while true; do
    read -t 0.001 line && printf "$line\n" >&3
    if [ $? == 1 ]; then
        exec 3>&-
    fi

    read -t 0.001 -u5 line     && printf "$line\n" >&2
    read -t 0.001 -N1 -u4 char && printf "$char"
    if [ $? == 1 ]; then
        exit 0
    fi
done
