#!/usr/bin/env bash

skip=false

jvm_args=''

for arg in "$@"; do
    if [ -z $main_class ]; then
        if $skip; then
            skip=false
        else
            if [ $arg == "-cp" ] || [ $arg == "-classpath" ]; then
                skip=true
            elif [[ $arg != -* ]]; then
                main_class=$arg
                continue
            fi
        fi
        jvm_args="$jvm_args $arg"
    else
        if [ -z $main_args ]; then
            main_args=$arg
        else
            main_args="$main_args\t$arg"
        fi
    fi
done

rm decaf.in decaf.out decaf.err
mkfifo decaf.in
mkfifo decaf.out
mkfifo decaf.err

java $jvm_args org.flatland.decaf.Main < decaf.in > decaf.out 2> decaf.err &

function duplex_stderr {
    exec 5< decaf.err
    while read -u5 line; do
        printf "$line\n" >&2
    done
}

function duplex_stdout {
    IFS=
    exec 4< decaf.out
    while read -d$'\4' -n1 -u4 char; do
        printf "$char"
    done
}

function duplex_stdin {
    exec 3> decaf.in
    printf "$main_class\n$main_args\n" >&3

    while read line 2> /dev/null; do
        printf "$line\n" >&3
    done
    exec 3>&-
}

duplex_stdin <&1 &
duplex_stderr &
duplex_stdout

exit 0
